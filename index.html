<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Navigator v10 | Classified System</title>
    <style>
        :root { --bg: #030508; --card: #0d1117; --accent: #3b82f6; --text: #f0f6fc; --danger: #f85149; }
        body { background: var(--bg); color: var(--text); font-family: 'Courier New', Courier, monospace; margin: 0; }
        
        /* Navigation */
        .navbar { display: flex; justify-content: space-between; align-items: center; padding: 15px 40px; background: #0d1117; border-bottom: 1px solid #30363d; }
        
        /* Grille des dossiers */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; padding: 40px; }
        .public-card { background: var(--card); border: 1px solid #30363d; padding: 30px; border-radius: 4px; text-align: center; cursor: pointer; transition: 0.3s; position: relative; overflow: hidden; }
        .public-card:hover { border-color: var(--accent); transform: scale(1.02); }
        .public-card::before { content: "TOP SECRET"; position: absolute; top: 10px; right: -30px; background: var(--danger); color: black; font-size: 10px; padding: 2px 30px; transform: rotate(45deg); opacity: 0.6; }

        /* MODALE PROFIL */
        #profile-page { position: fixed; inset: 0; background: var(--bg); z-index: 200; display: none; overflow-y: auto; padding: 40px; }
        
        /* STYLE DE CENSURE */
        .redacted {
            background: black;
            color: black;
            user-select: none;
            padding: 0 4px;
            border-radius: 2px;
            cursor: not-allowed;
            letter-spacing: -2px; /* Rend le texte compact */
        }
        
        /* ADMIN PANEL */
        .admin-box { background: #161b22; border: 1px dashed var(--accent); padding: 25px; margin-top: 40px; display: none; }
        .censure-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; background: #0d1117; padding: 15px; margin: 15px 0; border: 1px solid #30363d; }
        
        /* INPUTS */
        input, select, textarea { width: 100%; background: #0d1117; border: 1px solid #30363d; color: var(--text); padding: 10px; box-sizing: border-box; font-family: inherit; margin-bottom: 10px; }
        .btn { padding: 12px 20px; border: none; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        .btn-save { background: var(--accent); color: white; width: 100%; margin-top: 20px; }
        .btn-del { background: var(--danger); color: white; width: 100%; margin-top: 10px; }

        /* STATS */
        .stat-bar { background: #21262d; height: 10px; margin-top: 5px; border-radius: 5px; overflow: hidden; }
        .stat-fill { background: var(--accent); height: 100%; width: 0%; transition: width 1s ease-in-out; }
    </style>
</head>
<body>

<div class="navbar">
    <div style="font-weight: 900; color: var(--accent); font-size: 1.5rem;">NAVIGATOR <span style="color:white">v10</span></div>
    <div style="display:flex; gap:10px;">
        <button id="btn-new" onclick="openNew()" style="display:none; background:var(--accent); color:white;" class="btn">+ DOSSIER</button>
        <button id="admin-btn" onclick="askAdmin()" class="btn" style="background:none; border:1px solid #333; color:white;">Login Admin</button>
    </div>
</div>

<div class="grid" id="main-grid"></div>

<div id="profile-page">
    <div style="max-width: 900px; margin: auto;">
        <button onclick="closeProfile()" class="btn" style="background:#30363d; color:white; margin-bottom:20px;">‚Üê FERMER LE DOSSIER</button>

        <div style="display:flex; gap:30px; align-items:flex-start;">
            <img id="v-avatar" style="width:160px; height:160px; object-fit:cover; background:#111; border:2px solid #30363d;">
            <div style="flex:1;">
                <h1 id="v-name" style="margin:0; text-transform:uppercase; letter-spacing:2px;"></h1>
                <div id="v-job" style="color:var(--accent); font-weight:bold; margin:10px 0;"></div>
                <div id="v-loc" style="color:#8b949e; font-size:0.9em;"></div>
                <div id="v-level" style="border:1px solid #8b949e; display:inline-block; padding:2px 8px; margin-top:10px; font-size:0.8em;"></div>
            </div>
        </div>

        <div style="background:#0d1117; padding:30px; border:1px solid #30363d; margin-top:30px;">
            <h3 style="margin-top:0; border-bottom:1px solid #30363d; padding-bottom:10px;">RAPPORT BIOGRAPHIQUE</h3>
            <p id="v-bio" style="line-height:1.6; white-space: pre-wrap;"></p>
        </div>

        <div id="v-stats" style="margin-top:30px;"></div>

        <div id="admin-editor" class="admin-box">
            <h2 style="color:var(--accent); margin-top:0;">EDITER LE DOSSIER</h2>
            
            <div style="background:#21262d; padding:10px; margin-bottom:20px; font-size:0.9em;">
                <b>ASTUCE CENSURE :</b><br>
                1. Cochez les cases ci-dessous pour masquer tout le champ.<br>
                2. Dans la Bio, √©crivez entre √©toiles pour masquer un mot (ex: **Secret**).
            </div>

            <div class="censure-grid" id="censure-checks">
                <label><input type="checkbox" value="prenom"> Masquer Pr√©nom</label>
                <label><input type="checkbox" value="nom"> Masquer Nom</label>
                <label><input type="checkbox" value="profession"> Masquer Job</label>
                <label><input type="checkbox" value="localisation"> Masquer Lieu</label>
                <label><input type="checkbox" value="bio"> Masquer Bio</label>
                <label><input type="checkbox" value="stats"> Masquer Stats</label>
                <label><input type="checkbox" value="avatar"> Masquer Photo</label>
            </div>

            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                <input type="text" id="ed-id" placeholder="ID Unique (ex: user_01)">
                <input type="text" id="ed-pass" placeholder="Mot de Passe du Dossier">
                <input type="text" id="ed-prenom" placeholder="Pr√©nom">
                <input type="text" id="ed-nom" placeholder="Nom">
                <input type="text" id="ed-job" placeholder="Profession">
                <input type="text" id="ed-loc" placeholder="Localisation">
            </div>

            <label>Niveau de Menace</label>
            <select id="ed-level">
                <option>Niveau 1 - Surveillance</option>
                <option>Niveau 2 - Danger</option>
                <option>Niveau 3 - Critique</option>
                <option>Niveau 4 - √âlimination</option>
            </select>

            <label>Avatar URL</label>
            <input type="text" id="ed-avatar">

            <label>Biographie (Utilisez **mot** pour censurer)</label>
            <textarea id="ed-bio" rows="6"></textarea>

            <div style="margin-top:20px;">
                <div style="display:flex; justify-content:space-between;"><b>STATISTIQUES</b> <button onclick="addStatRow()">+</button></div>
                <div id="ed-stats-area"></div>
            </div>

            <button onclick="save()" class="btn btn-save">üíæ SAUVEGARDER</button>
            <button onclick="remove()" class="btn btn-del">SUPPRIMER</button>
        </div>
    </div>
</div>

<script>
    // ‚ö†Ô∏è REMPLACE PAR TON URL NGROK ICI (SANS LE SLASH √Ä LA FIN)
    const API = "https://economically-pseudoetymological-serenity.ngrok-free.dev";
    
    let ADMIN_CODE = "";

    // Charge la liste publique
    async function loadPublic() {
        try {
            const r = await fetch(`${API}/public_list`, {headers: {"ngrok-skip-browser-warning": "1"}});
            const ids = await r.json();
            const grid = document.getElementById('main-grid');
            grid.innerHTML = ids.map(id => `
                <div class="public-card" onclick="openProfile('${id}')">
                    <div style="font-size:1.5em; font-weight:bold;">${id}</div>
                    <div style="font-size:0.8em; margin-top:10px; color:#8b949e">CLASSIFIED FILE</div>
                </div>
            `).join('');
        } catch(e) { console.error("Erreur connexion API"); }
    }

    // Ouvre un dossier
    async function openProfile(id) {
        let pass = "";
        // Si on n'est pas admin, on doit entrer le MDP du profil
        if(!ADMIN_CODE) {
            pass = prompt("IDENTIFICATION REQUISE (Mot de passe du dossier) :");
            if(!pass) return;
        }

        const r = await fetch(`${API}/get_details`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', "ngrok-skip-browser-warning": "1"},
            body: JSON.stringify({id: id, password: pass, admin_code: ADMIN_CODE})
        });

        if(r.ok) {
            renderProfile(await r.json());
        } else {
            alert("ACC√àS REFUS√â : Mot de passe incorrect.");
        }
    }

    // Affiche le profil et g√®re la censure visuelle
    function renderProfile(d) {
        document.getElementById('profile-page').style.display = "block";

        // Fonction magique qui transforme les blocs noirs du serveur en HTML style
        const fmt = (txt) => {
            if(!txt) return "";
            // Remplace les blocs du serveur par des spans stylis√©s
            return txt.replace(/‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà/g, '<span class="redacted">CONFIDENTIAL</span>'); 
        };

        // Remplissage Vue Publique
        document.getElementById('v-avatar').src = d.avatar || "https://via.placeholder.com/150?text=NO+IMAGE";
        document.getElementById('v-name').innerHTML = `${fmt(d.prenom)} ${fmt(d.nom)}`;
        document.getElementById('v-job').innerHTML = fmt(d.profession);
        document.getElementById('v-loc').innerHTML = `DERNI√àRE POSITION : ${fmt(d.localisation)}`;
        document.getElementById('v-bio').innerHTML = fmt(d.bio);
        document.getElementById('v-level').innerText = d.niveau || "N/A";

        // Stats
        let sHtml = "<h3>PARAM√àTRES VITAUX</h3>";
        if(d.stats && d.stats["DONN√âES"] === 0) {
            sHtml += "<div class='redacted'>DONN√âES STATISTIQUES MASQU√âES</div>";
        } else {
            Object.entries(d.stats).forEach(([k,v]) => {
                sHtml += `<div style="margin-top:10px; font-size:0.8em;">${k} (${v}%)</div>
                          <div class="stat-bar"><div class="stat-fill" style="width:${v}%"></div></div>`;
            });
        }
        document.getElementById('v-stats').innerHTML = sHtml;

        // Remplissage Admin (si connect√©)
        if(d.is_admin) {
            document.getElementById('admin-editor').style.display = "block";
            
            // On remplit les champs avec les vraies valeurs
            document.getElementById('ed-id').value = d.id;
            document.getElementById('ed-id').disabled = true; // On ne change pas l'ID
            document.getElementById('ed-prenom').value = d.prenom;
            document.getElementById('ed-nom').value = d.nom;
            document.getElementById('ed-pass').value = d.password; // Admin voit le MDP
            document.getElementById('ed-job').value = d.profession;
            document.getElementById('ed-loc').value = d.localisation;
            document.getElementById('ed-level').value = d.niveau;
            document.getElementById('ed-avatar').value = d.avatar;
            document.getElementById('ed-bio').value = d.bio; // Admin voit le texte avec les **
            
            // Cocher les cases de censure
            document.querySelectorAll('#censure-checks input').forEach(cb => {
                cb.checked = d.censored.includes(cb.value);
            });

            // Stats √©ditables
            const area = document.getElementById('ed-stats-area');
            area.innerHTML = "";
            Object.entries(d.stats).forEach(([k,v]) => addStatRow(k,v));
        } else {
            document.getElementById('admin-editor').style.display = "none";
        }
    }

    // Fonctions utilitaires Admin
    function addStatRow(k="", v=50) {
        const div = document.createElement('div');
        div.className = "stat-row";
        div.style = "display:flex; gap:10px; margin-top:5px;";
        div.innerHTML = `<input type="text" class="sk" value="${k}" placeholder="Nom Stat"> <input type="number" class="sv" value="${v}" style="width:70px">`;
        document.getElementById('ed-stats-area').appendChild(div);
    }

    function openNew() {
        // Ouvre un profil vide pour cr√©ation
        renderProfile({
            id:"", prenom:"", nom:"", bio:"", avatar:"", profession:"", localisation:"", niveau:"Niveau 1",
            stats:{}, censored:[], password:"", is_admin:true
        });
        document.getElementById('ed-id').disabled = false;
        document.getElementById('ed-id').value = "";
    }

    async function save() {
        // R√©cup√®re les stats
        const stats = {};
        document.querySelectorAll('.stat-row').forEach(row => {
            const k = row.querySelector('.sk').value;
            const v = row.querySelector('.sv').value;
            if(k) stats[k] = parseInt(v);
        });

        // R√©cup√®re les censures coch√©es
        const censored = Array.from(document.querySelectorAll('#censure-checks input:checked')).map(cb => cb.value);

        const payload = {
            id: document.getElementById('ed-id').value,
            prenom: document.getElementById('ed-prenom').value,
            nom: document.getElementById('ed-nom').value,
            categories: ["User"], status: "Actif",
            bio: document.getElementById('ed-bio').value,
            avatar: document.getElementById('ed-avatar').value,
            stats: stats,
            profile_pass: document.getElementById('ed-pass').value,
            profession: document.getElementById('ed-job').value,
            localisation: document.getElementById('ed-loc').value,
            niveau: document.getElementById('ed-level').value,
            censored: censored,
            admin_code: ADMIN_CODE
        };

        if(!payload.id || !payload.profile_pass) return alert("ID et Mot de passe requis !");

        await fetch(`${API}/update`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', "ngrok-skip-browser-warning": "1"},
            body: JSON.stringify(payload)
        });
        
        closeProfile();
        loadPublic();
    }

    async function remove() {
        if(!confirm("Supprimer ce dossier d√©finitivement ?")) return;
        await fetch(`${API}/delete`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', "ngrok-skip-browser-warning": "1"},
            body: JSON.stringify({id: document.getElementById('ed-id').value, code: ADMIN_CODE})
        });
        closeProfile();
        loadPublic();
    }

    function askAdmin() {
        const p = prompt("CODE ADMINISTRATEUR :");
        if(p === "ExpA22") {
            ADMIN_CODE = p;
            document.getElementById('admin-btn').innerText = "ADMIN ACTIVE";
            document.getElementById('admin-btn').style.color = "#ef4444";
            document.getElementById('btn-new').style.display = "block";
            alert("MODE ADMIN ACTIV√â : Acc√®s illimit√©.");
        } else {
            alert("Code erron√©.");
        }
    }

    function closeProfile() {
        document.getElementById('profile-page').style.display = "none";
    }

    // D√©marrage
    loadPublic();
</script>
</body>
</html>
